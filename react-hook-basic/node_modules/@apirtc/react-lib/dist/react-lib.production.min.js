!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("react"),require("@apirtc/apirtc")):"function"==typeof define&&define.amd?define(["exports","react","@apirtc/apirtc"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).ApiRtcReactLib={},e.React,e.apiRTC)}(this,(function(e,t,o){"use strict";function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var a=n(t);const s="useCameraStream";const i="useConversation";const l="useConversationMessages";const r="useConversationModeration";function c(e){return null!=e}const b="useConversationStreams";const u="usePresence";const g="useSession";const d="useStreamApplyVideoProcessor";const f={audioinput:{},audiooutput:{},videoinput:{}};const L={level:"info",isDebugEnabled:!1,isInfoEnabled:!0,isWarnEnabled:!0};function p(e){switch(e){case"debug":globalThis.apirtcReactLibLogLevel={level:"debug",isDebugEnabled:!0,isInfoEnabled:!0,isWarnEnabled:!0};break;case"info":default:globalThis.apirtcReactLibLogLevel=L;break;case"warn":globalThis.apirtcReactLibLogLevel={level:"warn",isDebugEnabled:!1,isInfoEnabled:!1,isWarnEnabled:!0};break;case"error":globalThis.apirtcReactLibLogLevel={level:"error",isDebugEnabled:!1,isInfoEnabled:!1,isWarnEnabled:!1}}return globalThis.apirtcReactLibLogLevel}globalThis.apirtcReactLibLogLevel=L,globalThis.setApirtcReactLibLogLevel=p,e.VideoStream=function(e){const{autoPlay:o=!0}=e,n=t.useRef(null);return t.useEffect((()=>{const t=n.current;if(t&&e.stream)return e.stream.attachToElement(t),()=>{t.src=""}}),[e.stream]),a.default.createElement("video",{id:e.stream.getId(),style:{maxWidth:"100%"},ref:n,autoPlay:o,muted:e.muted})},e.setLogLevel=p,e.useCameraStream=function(e,o={}){const[n,a]=t.useState();return t.useEffect((()=>{if(e){e.getUserAgent().createStream(o).then((e=>{globalThis.apirtcReactLibLogLevel.isInfoEnabled&&console.info(s+"|createStream",o,e),a(e)})).catch((e=>{console.error(s+"|createStream",o,e),a(void 0)}))}else a(void 0)}),[e,JSON.stringify(o)]),t.useEffect((()=>()=>{n&&(globalThis.apirtcReactLibLogLevel.isInfoEnabled&&console.info(s+"|release stream",n),n.release())}),[n]),{stream:n}},e.useConversation=function(e,o,n,a=!1){const[s,l]=t.useState(),[r,c]=t.useState(!1),[b,u]=t.useState(!1),g=t.useCallback((()=>(globalThis.apirtcReactLibLogLevel.isDebugEnabled&&console.debug(i+"|join",s),new Promise(((e,t)=>{s?s.isJoined()?t(i+"|join|conversation already joined"):(u(!0),s.join().then((()=>{c(!0),e()})).catch((e=>{t(e)})).finally((()=>{u(!1)}))):t(i+"|join|conversation not defined")})))),[s]),d=t.useCallback((()=>(globalThis.apirtcReactLibLogLevel.isDebugEnabled&&console.debug(i+"|leave",s),new Promise(((e,t)=>{s?s.isJoined()?s.leave().then((()=>{c(!1),e()})).catch((e=>{t(e)})):t(i+"|leave|conversation is not joined"):t(i+"|leave|conversation not defined")})))),[s]);return t.useEffect((()=>{if(e&&o){globalThis.apirtcReactLibLogLevel.isDebugEnabled&&console.debug(i+"|getOrCreateConversation",o,n,a);const t=e.getOrCreateConversation(o,n);return l(t),()=>{globalThis.apirtcReactLibLogLevel.isDebugEnabled&&console.debug(i+"|useEffect cleanup",o,n,a),t.isJoined()?t.leave().then((()=>{})).catch((e=>{globalThis.apirtcReactLibLogLevel.isWarnEnabled&&console.warn(i+"|useEffect conversation.leave()",e)})).finally((()=>{t.destroy(),l(void 0),c(!1)})):(t.destroy(),l(void 0))}}}),[e,o,JSON.stringify(n)]),t.useEffect((()=>{if(s&&a){globalThis.apirtcReactLibLogLevel.isDebugEnabled&&console.debug(i+"|useEffect",s,a);const e=s,t=a;return t&&(u(!0),e.join().then((()=>{globalThis.apirtcReactLibLogLevel.isInfoEnabled&&console.info(i+"|joined",e),c(!0)})).catch((e=>{globalThis.apirtcReactLibLogLevel.isWarnEnabled&&console.warn(i+"|useEffect conversation.join()",e)})).finally((()=>{u(!1)}))),()=>{globalThis.apirtcReactLibLogLevel.isDebugEnabled&&console.debug(i+"|useEffect cleanup",e,t),e.isJoined()&&e.leave().then((()=>{c(!1)})).catch((e=>{globalThis.apirtcReactLibLogLevel.isWarnEnabled&&console.warn(i+"|useEffect conversation.leave()",e)}))}}}),[s,a]),{conversation:s,joining:b,joined:r,join:g,leave:d}},e.useConversationMessages=function(e){const[o]=t.useState(new Array),[n,a]=t.useState(new Array);return t.useEffect((()=>{if(e){const t=t=>{globalThis.apirtcReactLibLogLevel.isInfoEnabled&&console.info(l+"|on:message:",e.getName(),t),o.push(t),a(Array.from(o))};return e.on("message",t),()=>{e.removeListener("message",t),o.length=0,a(new Array)}}}),[e]),{messages:n,sendMessage:t.useCallback(((t,n)=>new Promise(((s,i)=>{null==e||e.sendMessage(t).then((i=>{globalThis.apirtcReactLibLogLevel.isInfoEnabled&&console.info(l+"|sentMessage",e.getName(),i,t),o.push({content:t,sender:n,time:new Date}),a(Array.from(o)),s()})).catch((e=>{globalThis.apirtcReactLibLogLevel.isWarnEnabled&&console.warn(l+"|sendMessage error",e),i(e)}))}))),[e])}},e.useConversationModeration=function(e,o,n){const[a,s]=t.useState(new Set);return t.useEffect((()=>{if(globalThis.apirtcReactLibLogLevel.isDebugEnabled&&console.debug(r+"|useEffect conversation",e),e){const t=e=>{globalThis.apirtcReactLibLogLevel.isInfoEnabled&&console.info(r+"|on:contactJoinedWaitingRoom",e),a.add(e),s(new Set(a))},i=e=>{globalThis.apirtcReactLibLogLevel.isInfoEnabled&&console.info(r+"|on:contactLeftWaitingRoom",e),a.delete(e),s(new Set(a))},l=e=>{globalThis.apirtcReactLibLogLevel.isInfoEnabled&&console.info(r+"|on:participantEjected",e),!0===e.self?(globalThis.apirtcReactLibLogLevel.isInfoEnabled&&console.info(r+"|Self participant was ejected"),n&&n()):o&&o(e.contact)};return e.on("contactJoinedWaitingRoom",t).on("contactLeftWaitingRoom",i).on("participantEjected",l),()=>{globalThis.apirtcReactLibLogLevel.isDebugEnabled&&console.debug(r+"|conversation clear",e),e.removeListener("contactJoinedWaitingRoom",t).removeListener("contactLeftWaitingRoom",i).removeListener("participantEjected",l),s(new Set)}}}),[e]),{candidates:a}},e.useConversationStreams=function(e,o=[],n){globalThis.apirtcReactLibLogLevel.isDebugEnabled&&console.debug(`${b}|hook`);const[a,s]=t.useState([]),[i]=t.useState(new Array),[l,r]=t.useState(new Array),[u]=t.useState(new Array),[g,d]=t.useState(new Array),f=t.useCallback(((t,o)=>new Promise(((n,a)=>{e&&(globalThis.apirtcReactLibLogLevel.isDebugEnabled&&console.debug(`${b}|publish|${e.getName()}`,t,o),e.publish(t,o).then((t=>{globalThis.apirtcReactLibLogLevel.isInfoEnabled&&console.info(`${b}|published|${e.getName()}`,t),i.push(t),r(Array.from(i)),n(t)})).catch((e=>{a(e)})))}))),[e]),L=t.useCallback(((t,o,n)=>new Promise(((a,s)=>{if(e){globalThis.apirtcReactLibLogLevel.isDebugEnabled&&console.debug(`${b}|replacePublishedStream|${e.getName()}|${t.getId()} -> ${o.getId()}(${JSON.stringify(n)})`);const l=e.getConversationCall(t);l&&l.replacePublishedStream(o,void 0,n).then((o=>{globalThis.apirtcReactLibLogLevel.isInfoEnabled&&console.info(`${b}|stream replaced|${e.getName()}`,t,o,n);const s=i.indexOf(t);s>=0&&(i.splice(s,1,o),r(Array.from(i))),a(o)})).catch((e=>{s(e)}))}}))),[e]),p=t.useCallback((t=>{if(e){globalThis.apirtcReactLibLogLevel.isDebugEnabled&&console.debug(`${b}|unpublish|${e.getName()}`,t),e.unpublish(t);const o=i.indexOf(t);o>=0&&(i.splice(o,1),r(Array.from(i)))}}),[e]),h=t.useCallback((()=>{const t=Math.max(a.length,o.length);globalThis.apirtcReactLibLogLevel.isDebugEnabled&&console.debug(b+"|doHandlePublication",o,JSON.stringify(a.map((e=>null==e?void 0:e.stream.getId()))),t);const i=[...o];s(i);const l=new Set(o.filter(c).map((e=>e.stream)));for(let s=0;s<t;s++){const t=a[s],r=o[s];if(t&&r){const o=()=>{L(t.stream,r.stream,r.options).catch((e=>{i.splice(s,1,null),n?n(e):globalThis.apirtcReactLibLogLevel.isWarnEnabled&&console.warn(`${b}|replacePublishedStream|error`,e)}))};t.stream===r.stream?JSON.stringify(t.options)!==JSON.stringify(r.options)&&o():l.has(t.stream)?e&&!e.isPublishedStream(r.stream)&&f(r.stream,r.options).catch((e=>{i.splice(s,1,null),n?n(e):globalThis.apirtcReactLibLogLevel.isWarnEnabled&&console.warn(`${b}|publish|error`,e)})):e&&!e.isPublishedStream(r.stream)?o():p(t.stream)}else t&&!r?l.has(t.stream)||p(t.stream):!t&&r&&e&&!e.isPublishedStream(r.stream)&&f(r.stream,r.options).catch((e=>{i.splice(s,1,null),n?n(e):globalThis.apirtcReactLibLogLevel.isWarnEnabled&&console.warn(`${b}|publish|error`,e)}))}}),[e,o,a,f,p,L]);t.useEffect((()=>{if(e){const t=e=>{globalThis.apirtcReactLibLogLevel.isInfoEnabled&&console.info(b+"|on_streamAdded",e),u.push(e),d(Array.from(u))},o=e=>{globalThis.apirtcReactLibLogLevel.isInfoEnabled&&console.info(b+"|on_streamRemoved",e);const t=u.indexOf(e);t>=0&&(u.splice(t,1),d(Array.from(u)))},n=t=>{const o=String(t.streamId);!0===t.isRemote&&("added"===t.listEventType?e.subscribeToStream(o):"removed"===t.listEventType&&e.unsubscribeToStream(o))};return e.on("streamAdded",t),e.on("streamRemoved",o),e.on("streamListChanged",n),()=>{e.removeListener("streamListChanged",n),e.removeListener("streamRemoved",o),e.removeListener("streamAdded",t)}}}),[e]);const v=e=>{i.forEach((t=>{globalThis.apirtcReactLibLogLevel.isDebugEnabled&&console.debug(b+"|unpublish stream",e,t),e.unpublish(t)})),i.length=0,s([]),u.forEach((t=>{globalThis.apirtcReactLibLogLevel.isDebugEnabled&&console.debug(b+"|unsubscribeToStream stream",e,t),e.unsubscribeToStream(t.getId())})),u.length=0,r(new Array),d(new Array)};return t.useEffect((()=>{if(e){globalThis.apirtcReactLibLogLevel.isDebugEnabled&&console.debug(b+"|useEffect doHandlePublication",e.getName());const t=()=>{globalThis.apirtcReactLibLogLevel.isInfoEnabled&&console.info(b+"|on_joined",e.getName(),o),h()},n=()=>{globalThis.apirtcReactLibLogLevel.isInfoEnabled&&console.info(b+"|on_left",e.getName()),v(e)};return e.on("joined",t),e.on("left",n),()=>{e.removeListener("joined",t),e.removeListener("left",n)}}}),[h]),t.useEffect((()=>{if(e)return globalThis.apirtcReactLibLogLevel.isDebugEnabled&&console.debug(`${b}|conversation|${e.getName()}`,e),e.getAvailableStreamList().forEach((t=>{const o=String(t.streamId);!0===t.isRemote&&e.subscribeToStream(o)})),()=>{v(e)}}),[e]),t.useEffect((()=>{globalThis.apirtcReactLibLogLevel.isDebugEnabled&&console.debug(`${b}|streamsToPublish`,JSON.stringify(o.map((e=>(null==e?void 0:e.stream.getId())+"-"+JSON.stringify(null==e?void 0:e.options))))),e&&e.isJoined()&&h()}),[JSON.stringify(o.map((e=>(null==e?void 0:e.stream.getId())+"-"+JSON.stringify(null==e?void 0:e.options))))]),{publishedStreams:l,subscribedStreams:g,publish:f,unpublish:p,replacePublishedStream:L}},e.usePresence=function(e,o){const[n]=t.useState(new Set),[a]=t.useState(new Map),[s,i]=t.useState(new Map);t.useEffect((()=>{if(e)return()=>{a.clear(),i(new Map(a)),n.clear()}}),[e]);const l=e=>{var t;const o=null!==(t=a.get(e))&&void 0!==t?t:new Set;return a.has(e)||a.set(e,o),o};return t.useEffect((()=>{if(globalThis.apirtcReactLibLogLevel.isDebugEnabled&&console.debug(u+"|useEffect session, groups",o),e){const t=e,s=new Set(o);s.forEach((e=>{n.has(e)||(globalThis.apirtcReactLibLogLevel.isInfoEnabled&&console.info(u+"|subscribeToGroup",e),n.add(e),t.subscribeToGroup(e))}));let r=!1;if(n.forEach((e=>{s.has(e)||(globalThis.apirtcReactLibLogLevel.isInfoEnabled&&console.info(u+"|unsubscribeToGroup",e),t.unsubscribeToGroup(e),n.delete(e),a.delete(e),r=!0)})),r&&i(new Map(a)),o.length>0){const e=e=>{globalThis.apirtcReactLibLogLevel.isDebugEnabled&&console.debug(u+"|contactListUpdate",e);let t=!1;for(const o of Object.keys(e.joinedGroup))if(s.has(o)){const n=l(o);for(const a of e.joinedGroup[o])n.add(a),t=!0}for(const o of Object.keys(e.leftGroup))if(s.has(o)){const n=l(o);for(const s of e.leftGroup[o])n.delete(s),t=!0,0===n.size&&a.delete(o)}for(const o of e.userDataChanged)for(const e of a.values())if(e.has(o)){t=!0;break}t&&i(new Map(a))};return t.on("contactListUpdate",e),()=>{t.removeListener("contactListUpdate",e)}}}}),[e,JSON.stringify(o)]),{contactsByGroup:s}},e.useSession=function(e,n){const[a,s]=t.useState(),[i,l]=t.useState(!1),[r,c]=t.useState();t.useEffect((()=>{if(globalThis.apirtcReactLibLogLevel.isDebugEnabled&&console.debug(g+"|useEffect credentials, options",e,n),e){let t=!0;return b(e,n).catch((e=>{console.error(g+"|connection failed",e,t),s(void 0),t&&c(e)})),()=>{t=!1,s(void 0),l(!1),c(void 0)}}}),[JSON.stringify(e),JSON.stringify(n)]),t.useEffect((()=>{if(globalThis.apirtcReactLibLogLevel.isDebugEnabled&&console.debug(g+"|useEffect session",a),a){const e=a;return()=>{e.disconnect().then((()=>{globalThis.apirtcReactLibLogLevel.isInfoEnabled&&console.info(g+"|disconnected",e)})).catch((e=>{console.error(g+"|disconnect",e)}))}}}),[a]);const b=(e,t)=>new Promise(((n,a)=>{const i=t||{cloudUrl:"https://cloud.apirtc.com"};let r;if("object"==typeof(c=e)&&"username"in c)i.password=e.password,r=new o.UserAgent({uri:"apirtc:"+e.username});else if(function(e){return"object"==typeof e&&"apiKey"in e}(e))r=new o.UserAgent({uri:`apiKey:${e.apiKey}`});else{if(!function(e){return"object"==typeof e&&"token"in e}(e))return void a("credentials not recognized");r=new o.UserAgent({uri:`token:${e.token}`})}var c;l(!0),r.register(i).then((e=>{globalThis.apirtcReactLibLogLevel.isInfoEnabled&&console.info(g+"|connected",e),s(e),n()})).catch((e=>{a(e)})).finally((()=>{l(!1)}))}));return{session:a,connecting:i,connect:b,disconnect:()=>{s(void 0)},error:r}},e.useStreamApplyVideoProcessor=function(e,o,n,a){const[s,i]=t.useState(e),[l,r]=t.useState("none");t.useEffect((()=>{globalThis.apirtcReactLibLogLevel.isDebugEnabled&&console.debug(d+"|useEffect",e,o,n),e&&"none"!==o?e.applyVideoProcessor(o,n).then((e=>{i(e),r(o)})).catch((t=>{i(e),a?a(t):globalThis.apirtcReactLibLogLevel.isWarnEnabled&&console.warn(d+"|useEffect",e,o,n,t),r((e=>e))})):(i(e),r("none"))}),[e,o,n]);const c=t.useCallback((()=>{s&&s!==e&&(globalThis.apirtcReactLibLogLevel.isDebugEnabled&&console.debug(d+"|releasing outStream",s),s.release())}),[e,s]);return t.useEffect((()=>()=>{c()}),[s]),{stream:s,applied:l}},e.useUserMediaDevices=function(e){const[o,n]=t.useState(f);return t.useEffect((()=>{if(e){const t=e.getUserAgent(),o=()=>{const e=t.getUserMediaDevices();globalThis.apirtcReactLibLogLevel.isInfoEnabled&&console.info("useUserMediaDevices|mediaDeviceChanged",e),n(e)};return t.on("mediaDeviceChanged",o),()=>{t.removeListener("mediaDeviceChanged",o),n(f)}}}),[e]),{userMediaDevices:o}},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=react-lib.production.min.js.map
